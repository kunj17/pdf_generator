name: Generate Waiver PDF and Add to Email Queue

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Participant Name"
        required: true
      initials:
        description: "Initials"
        required: true
      is_minor:
        description: "Is Minor (true/false)"
        required: true
      unique_id:
        description: "Unique PDF ID"
        required: true
      family_id:
        description: "Family Tag ID"
        required: true
      parent_email:
        description: "Parent Email"
        required: true
      member_json:
        description: "JSON array of member objects"
        required: true

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install pdf-lib

      - name: Generate PDF
        run: |
          node fill.js "$NAME" "$INITIALS" "$IS_MINOR" "$UNIQUE_ID"
        env:
          NAME: ${{ github.event.inputs.name }}
          INITIALS: ${{ github.event.inputs.initials }}
          IS_MINOR: ${{ github.event.inputs.is_minor }}
          UNIQUE_ID: ${{ github.event.inputs.unique_id }}

      - name: Commit generated PDF to repo
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add filled/Waiver_${{ github.event.inputs.unique_id }}.pdf
          git commit -m "Add waiver PDF for ${{ github.event.inputs.unique_id }}"
          git push

      - name: Add Family to Email Queue
        run: |
          mkdir -p queue
          node updateQueueStatus.js "$FAMILY_ID" "$PARENT_EMAIL" "$MEMBER_JSON"
        env:
          FAMILY_ID: ${{ github.event.inputs.family_id }}
          PARENT_EMAIL: ${{ github.event.inputs.parent_email }}
          MEMBER_JSON: ${{ github.event.inputs.member_json }}

      - name: Commit updated queue
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add queue/ready_to_email.json
          git commit -m "ðŸ†• Add ${{ github.event.inputs.family_id }} to email queue"
          git push
